<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffccff">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق سور جزء عم للأطفال</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 30px; background-color: #f0f8ff;}
        .balloon { display: inline-block; width: 100px; height: 100px; line-height: 100px; border-radius: 50%; background-color: #ffccff; margin: 10px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3);}
        .balloon:hover { background-color: #ff99ff;}
        .word-container { margin-top: 30px; font-size: 30px;}
        .letter-box { width: 30px; height: 40px; text-align: center; font-size: 24px; margin: 5px;}
        .letter-correct { color: #000;}
        .faded { color: #ccc; margin-left: 5px; margin-right: 5px;}
        .revealed { color: #000;}
    </style>
</head>
<body>
    <h2 id="header">اختر سورة من جزء عم</h2>
    <div id="balloon-container"></div>
    <div class="word-container" id="word-container">
        <div id="completedVerses"></div>
        <div id="inputArea"></div>
    </div>
    <audio id="audioPlayer" src="" style="display:none"></audio>
    <script>
    let surahs = {};
    const juzAmmaRange = {start: 78, end: 114};
    const surahNames = [
        "النبأ", "النازعات", "عبس", "التكوير", "الانفطار", "المطففين", "الانشقاق", "البروج", "الطارق", "الأعلى", 
        "الغاشية", "الفجر", "البلد", "الشمس", "الليل", "الضحى", "الشرح", "التين", "العلق", "القدر", 
        "البينة", "الزلزلة", "العاديات", "القارعة", "التكاثر", "العصر", "الهمزة", "الفيل", "قريش", "الماعون", 
        "الكوثر", "الكافرون", "النصر", "المسد", "الإخلاص", "الفلق", "الناس"
    ];
    let currentSurahWords = [];
    let currentWordIndex = 0;
    let solvedWords = [];
    function removeDiacritics(text) {
        return text
            .normalize("NFD")
            .replace(/[ً-ٰٟ‌ـۖ-ۭؐ-ؚ۟-۠]/g, '')
            .replace(/ٱ/g, 'ا');
    }
    fetch('quran.json')
    .then(response => response.json())
    .then(data => {
        surahs = data;
        createBalloons();
    });
    function createBalloons() {
        const container = document.getElementById('balloon-container');
        surahNames.forEach((name, index) => {
            const balloon = document.createElement('div');
            balloon.className = 'balloon';
            balloon.innerText = `سورة ${name}`;
            balloon.onclick = () => startSurah(index + juzAmmaRange.start);
            container.appendChild(balloon);
        });
    }
    function startSurah(surahNumber) {
        document.getElementById('balloon-container').style.display = 'none';
        document.getElementById('header').innerText = `سورة ${surahNames[surahNumber - juzAmmaRange.start]}`;
        currentSurahWords = [];
        surahs[surahNumber].forEach((verse, i) => {
            const words = removeDiacritics(verse.text).split(' ');
            words.forEach(word => {
                currentSurahWords.push({ word, verse: i + 1 });
            });
        });
        currentWordIndex = 0;
        solvedWords = [];
        showCurrentWord();
    }
    function showCompletedVerses(livePartial = "") {
        const completedDiv = document.getElementById('completedVerses');
        completedDiv.innerHTML = '';
        const basmalaLine = document.createElement('div');
        basmalaLine.innerText = 'بسم الله الرحمن الرحيم';
        basmalaLine.classList.add('letter-correct');
        completedDiv.appendChild(basmalaLine);

        // Build words for each verse
        let map = {};
        solvedWords.forEach(obj => {
            if (!map[obj.verse]) map[obj.verse] = [];
            map[obj.verse].push(obj.word);
        });

        // Add current live (incomplete) word, if present, to current verse
        if (currentWordIndex < currentSurahWords.length && livePartial.length > 0) {
            let verse = currentSurahWords[currentWordIndex].verse;
            if (!map[verse]) map[verse] = [];
            map[verse].push(livePartial);
        }

        // Display all verses and their words, add verse number if fully completed
        let verses = Object.keys(map).sort((a,b)=>+a-+b);
        for (let i = 0; i < verses.length; i++) {
            let verseNum = parseInt(verses[i]);
            let words = map[verseNum];
            let totalWords = currentSurahWords.filter(w => w.verse === verseNum).length;
            let div = document.createElement('div');
            div.classList.add('letter-correct');
            div.innerHTML = words.join(' ') + (words.length === totalWords && (currentWordIndex >= currentSurahWords.length || verseNum !== currentSurahWords[currentWordIndex]?.verse) ? ` <span style="color:gray">(${verseNum})</span>` : '');
            completedDiv.appendChild(div);
        }
    }
    function showCurrentWord() {
        const inputArea = document.getElementById('inputArea');
        inputArea.innerHTML = '';
        if (currentWordIndex >= currentSurahWords.length) {
            showCompletedVerses("");
            return;
        }
        const wordObj = currentSurahWords[currentWordIndex];
        const word = wordObj.word;
        const letters = word.split('');
        const fadedContainer = document.createElement('div');
        fadedContainer.style.marginBottom = '10px';
        letters.forEach(letter => {
            const span = document.createElement('span');
            span.innerText = letter;
            span.className = 'faded';
            fadedContainer.appendChild(span);
        });
        inputArea.appendChild(fadedContainer);

        const inputBoxes = [];
        let livePartial = "";
        letters.forEach((letter, index) => {
            const input = document.createElement('input');
            input.classList.add('letter-box');
            input.maxLength = 1;

            input.addEventListener('input', () => {
                if (input.value === letter) {
                    input.disabled = true;
                    input.style.backgroundColor = '#cfc';
                    fadedContainer.children[index].classList.remove('faded');
                    fadedContainer.children[index].classList.add('revealed');
                    // Build livePartial from all input boxes
                    livePartial = "";
                    for (let j = 0; j < inputBoxes.length; j++) {
                        livePartial += inputBoxes[j].value;
                    }
                    showCompletedVerses(livePartial);

                    if (index + 1 < inputBoxes.length) {
                        inputBoxes[index + 1].focus();
                    } else {
                        // Word complete, add to solvedWords
                        const verseId = wordObj.verse;
                        solvedWords.push({ word, verse: verseId });
                        currentWordIndex++;
                        setTimeout(() => {
                            showCurrentWord();
                        }, 400);
                    }
                } else if (input.value !== "") {
                    input.value = '';
                }
            });
            inputBoxes.push(input);
            inputArea.appendChild(input);
        });
        // On initial render, also show (empty) livePartial so previous words display
        showCompletedVerses("");
        inputBoxes[0].focus();
    }
    </script>
</body>
</html>
